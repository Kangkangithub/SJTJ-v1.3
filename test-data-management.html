<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­¦å™¨æ•°æ®ç®¡ç†æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #229954;
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        .status.online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ æ­¦å™¨æ•°æ®ç®¡ç†ç³»ç»Ÿæµ‹è¯•</h1>
            <p>æµ‹è¯•æ­¦å™¨æ•°æ®çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½</p>
            <div id="serverStatus" class="status offline">
                æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥ä¸­...
            </div>
        </div>

        <!-- æœåŠ¡å™¨è¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ”— æœåŠ¡å™¨è¿æ¥æµ‹è¯•</h3>
            <button class="btn" onclick="testServerConnection()">æµ‹è¯•è¿æ¥</button>
            <button class="btn btn-success" onclick="testHealthCheck()">å¥åº·æ£€æŸ¥</button>
            <div id="connectionResult" class="result" style="display: none;"></div>
        </div>

        <!-- æ­¦å™¨æ•°æ®æŸ¥è¯¢æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ“‹ æ­¦å™¨æ•°æ®æŸ¥è¯¢</h3>
            <button class="btn" onclick="getWeaponsList()">è·å–æ­¦å™¨åˆ—è¡¨</button>
            <button class="btn" onclick="getWeaponStatistics()">è·å–ç»Ÿè®¡ä¿¡æ¯</button>
            <button class="btn" onclick="searchWeapons()">æœç´¢æ­¦å™¨ (AK)</button>
            <div id="queryResult" class="result" style="display: none;"></div>
        </div>

        <!-- æ­¦å™¨æ·»åŠ æµ‹è¯• -->
        <div class="test-section">
            <h3>â• æ­¦å™¨æ·»åŠ æµ‹è¯•</h3>
            <form id="addWeaponForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>æ­¦å™¨åç§° *</label>
                        <input type="text" id="weaponName" value="æµ‹è¯•æ­¦å™¨-AK74" required>
                    </div>
                    <div class="form-group">
                        <label>æ­¦å™¨ç±»å‹ *</label>
                        <select id="weaponType" required>
                            <option value="æ­¥æª">æ­¥æª</option>
                            <option value="æ‰‹æª">æ‰‹æª</option>
                            <option value="æœºæª">æœºæª</option>
                            <option value="ç‹™å‡»æª">ç‹™å‡»æª</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>åˆ¶é€ å›½å®¶ *</label>
                        <select id="weaponCountry" required>
                            <option value="ä¿„ç½—æ–¯">ä¿„ç½—æ–¯</option>
                            <option value="ç¾å›½">ç¾å›½</option>
                            <option value="ä¸­å›½">ä¸­å›½</option>
                            <option value="å¾·å›½">å¾·å›½</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æœå½¹å¹´ä»½</label>
                        <input type="number" id="weaponYear" value="1974" min="1800" max="2030">
                    </div>
                </div>
                <div class="form-group">
                    <label>æ­¦å™¨æè¿°</label>
                    <textarea id="weaponDescription" rows="3">è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ­¦å™¨ï¼Œç”¨äºéªŒè¯æ•°æ®ç®¡ç†åŠŸèƒ½ã€‚</textarea>
                </div>
            </form>
            <button class="btn btn-success" onclick="addTestWeapon()">æ·»åŠ æµ‹è¯•æ­¦å™¨</button>
            <button class="btn" onclick="addTestWeaponDirect()">ç›´æ¥æ·»åŠ  (ç®¡ç†å‘˜)</button>
            <div id="addResult" class="result" style="display: none;"></div>
        </div>

        <!-- åˆ¶é€ å•†ç®¡ç†æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ­ åˆ¶é€ å•†ç®¡ç†æµ‹è¯•</h3>
            <button class="btn" onclick="getManufacturersList()">è·å–åˆ¶é€ å•†åˆ—è¡¨</button>
            <button class="btn btn-success" onclick="addTestManufacturer()">æ·»åŠ æµ‹è¯•åˆ¶é€ å•†</button>
            <div id="manufacturerResult" class="result" style="display: none;"></div>
        </div>

        <!-- æ‰¹é‡æ“ä½œæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ“¦ æ‰¹é‡æ“ä½œæµ‹è¯•</h3>
            <button class="btn" onclick="batchAddWeapons()">æ‰¹é‡æ·»åŠ æ­¦å™¨</button>
            <button class="btn btn-danger" onclick="cleanupTestData()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
            <div id="batchResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        window.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
        });

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const result = await response.json();
                
                const statusDiv = document.getElementById('serverStatus');
                if (response.ok && result.success) {
                    statusDiv.className = 'status online';
                    statusDiv.textContent = `âœ… æœåŠ¡å™¨åœ¨çº¿ - ${result.database} æ•°æ®åº“`;
                } else {
                    throw new Error('æœåŠ¡å™¨å“åº”å¼‚å¸¸');
                }
            } catch (error) {
                const statusDiv = document.getElementById('serverStatus');
                statusDiv.className = 'status offline';
                statusDiv.textContent = `âŒ æœåŠ¡å™¨ç¦»çº¿ - ${error.message}`;
            }
        }

        // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        async function testServerConnection() {
            showResult('connectionResult', 'æ­£åœ¨æµ‹è¯•è¿æ¥...', 'success');
            
            try {
                const response = await fetch(`${API_BASE}`);
                const result = await response.json();
                showResult('connectionResult', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                showResult('connectionResult', `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¥åº·æ£€æŸ¥
        async function testHealthCheck() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const result = await response.json();
                showResult('connectionResult', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                showResult('connectionResult', `å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–æ­¦å™¨åˆ—è¡¨
        async function getWeaponsList() {
            try {
                const response = await fetch(`${API_BASE}/weapons?limit=5`);
                const result = await response.json();
                showResult('queryResult', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                showResult('queryResult', `è·å–æ­¦å™¨åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–ç»Ÿè®¡ä¿¡æ¯
        async function getWeaponStatistics() {
            try {
                const response = await fetch(`${API_BASE}/weapons/statistics`);
                const result = await response.json();
                showResult('queryResult', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                showResult('queryResult', `è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æœç´¢æ­¦å™¨
        async function searchWeapons() {
            try {
                const response = await fetch(`${API_BASE}/weapons/search?q=AK`);
                const result = await response.json();
                showResult('queryResult', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                showResult('queryResult', `æœç´¢æ­¦å™¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ·»åŠ æµ‹è¯•æ­¦å™¨
        async function addTestWeapon() {
            const weaponData = {
                name: document.getElementById('weaponName').value,
                type: document.getElementById('weaponType').value,
                country: document.getElementById('weaponCountry').value,
                year: parseInt(document.getElementById('weaponYear').value) || null,
                description: document.getElementById('weaponDescription').value,
                specifications: {
                    test: true,
                    added_by: 'test_system'
                }
            };

            try {
                const response = await fetch(`${API_BASE}/weapons`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token' // æµ‹è¯•token
                    },
                    body: JSON.stringify(weaponData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('addResult', `æ­¦å™¨æ·»åŠ æˆåŠŸ!\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResult('addResult', `æ·»åŠ å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('addResult', `æ·»åŠ æ­¦å™¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç›´æ¥æ·»åŠ æ­¦å™¨ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
        async function addTestWeaponDirect() {
            const weaponData = {
                name: document.getElementById('weaponName').value,
                type: document.getElementById('weaponType').value,
                country: document.getElementById('weaponCountry').value,
                year: parseInt(document.getElementById('weaponYear').value) || null,
                description: document.getElementById('weaponDescription').value,
                specifications: {
                    test: true,
                    added_by: 'direct_admin'
                }
            };

            try {
                const response = await fetch(`${API_BASE}/weapons/direct-add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-user': 'JunkangShen'
                    },
                    body: JSON.stringify(weaponData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('addResult', `æ­¦å™¨ç›´æ¥æ·»åŠ æˆåŠŸ!\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResult('addResult', `ç›´æ¥æ·»åŠ å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('addResult', `ç›´æ¥æ·»åŠ æ­¦å™¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–åˆ¶é€ å•†åˆ—è¡¨
        async function getManufacturersList() {
            try {
                const response = await fetch(`${API_BASE}/manufacturers`);
                const result = await response.json();
                showResult('manufacturerResult', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                showResult('manufacturerResult', `è·å–åˆ¶é€ å•†åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ·»åŠ æµ‹è¯•åˆ¶é€ å•†
        async function addTestManufacturer() {
            const manufacturerData = {
                name: 'æµ‹è¯•å†›å·¥å…¬å¸',
                country: 'ä¸­å›½',
                founded: 2000,
                description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•åˆ¶é€ å•†'
            };

            try {
                const response = await fetch(`${API_BASE}/manufacturers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-user': 'JunkangShen'
                    },
                    body: JSON.stringify(manufacturerData)
                });

                const result = await response.json();
                showResult('manufacturerResult', JSON.stringify(result, null, 2), response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('manufacturerResult', `æ·»åŠ åˆ¶é€ å•†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‰¹é‡æ·»åŠ æ­¦å™¨
        async function batchAddWeapons() {
            const weapons = [
                {
                    name: 'æµ‹è¯•æ­¥æª-1',
                    type: 'æ­¥æª',
                    country: 'ç¾å›½',
                    year: 2020,
                    description: 'æ‰¹é‡æµ‹è¯•æ­¦å™¨1'
                },
                {
                    name: 'æµ‹è¯•æ‰‹æª-1',
                    type: 'æ‰‹æª',
                    country: 'å¾·å›½',
                    year: 2021,
                    description: 'æ‰¹é‡æµ‹è¯•æ­¦å™¨2'
                },
                {
                    name: 'æµ‹è¯•æœºæª-1',
                    type: 'æœºæª',
                    country: 'ä¿„ç½—æ–¯',
                    year: 2019,
                    description: 'æ‰¹é‡æµ‹è¯•æ­¦å™¨3'
                }
            ];

            showResult('batchResult', 'æ­£åœ¨æ‰¹é‡æ·»åŠ æ­¦å™¨...', 'success');
            
            let successCount = 0;
            let errorCount = 0;
            let results = [];

            for (const weapon of weapons) {
                try {
                    const response = await fetch(`${API_BASE}/weapons/direct-add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-admin-user': 'JunkangShen'
                        },
                        body: JSON.stringify(weapon)
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        successCount++;
                        results.push(`âœ… ${weapon.name} - æ·»åŠ æˆåŠŸ`);
                    } else {
                        errorCount++;
                        results.push(`âŒ ${weapon.name} - æ·»åŠ å¤±è´¥: ${result.message}`);
                    }
                } catch (error) {
                    errorCount++;
                    results.push(`âŒ ${weapon.name} - ç½‘ç»œé”™è¯¯: ${error.message}`);
                }
            }

            const summary = `æ‰¹é‡æ·»åŠ å®Œæˆ!\næˆåŠŸ: ${successCount} ä¸ª\nå¤±è´¥: ${errorCount} ä¸ª\n\nè¯¦ç»†ç»“æœ:\n${results.join('\n')}`;
            showResult('batchResult', summary, successCount > 0 ? 'success' : 'error');
        }

        // æ¸…ç†æµ‹è¯•æ•°æ®
        async function cleanupTestData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }

            showResult('batchResult', 'æ­£åœ¨æ¸…ç†æµ‹è¯•æ•°æ®...', 'success');
            
            try {
                // è¿™é‡Œéœ€è¦å®ç°æ¸…ç†é€»è¾‘
                // ç”±äºæ²¡æœ‰æ‰¹é‡åˆ é™¤æ¥å£ï¼Œè¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿ
                showResult('batchResult', 'æµ‹è¯•æ•°æ®æ¸…ç†åŠŸèƒ½éœ€è¦åœ¨åç«¯å®ç°æ‰¹é‡åˆ é™¤æ¥å£', 'error');
            } catch (error) {
                showResult('batchResult', `æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
    </script>
</body>
</html>